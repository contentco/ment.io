"use strict";angular.module("mentio",[]).directive("mentio",["mentioUtil","$document","$compile","$log","$timeout",function(e,t,n,i,r){return{restrict:"A",scope:{macros:"=mentioMacros",search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",typedTerm:"=mentioTypedTerm",altId:"=mentioId",iframeElement:"=mentioIframeElement",requireLeadingSpace:"=mentioRequireLeadingSpace",selectNotFound:"=mentioSelectNotFound",trimTerm:"=mentioTrimTerm",ngModel:"=",menuPosition:"=mentioMenuPosition",container:"@mentioContainer"},controller:["$scope","$timeout","$attrs",function(n,i,r){n.query=function(e,t){var i=n.triggerCharMap[e];(void 0===n.trimTerm||n.trimTerm)&&(t=t.trim()),i.showMenu(),i.search({term:t}),i.typedTerm=t},n.defaultSearch=function(e){var t=[];angular.forEach(n.items,function(n){n.label.toUpperCase().indexOf(e.term.toUpperCase())>=0&&t.push(n)}),n.localItems=t},n.bridgeSearch=function(e){var t=r.mentioSearch?n.search:n.defaultSearch;t({term:e})},n.defaultSelect=function(e){return n.defaultTriggerChar+e.item.label},n.bridgeSelect=function(e){var t=r.mentioSelect?n.select:n.defaultSelect;return t({item:e})},n.setTriggerText=function(e){n.syncTriggerText&&(n.typedTerm=void 0===n.trimTerm||n.trimTerm?e.trim():e)},n.context=function(){return n.iframeElement?{iframe:n.iframeElement}:void 0},n.replaceText=function(t,r){if(n.hideAll(),e.replaceTriggerText(n.context(),n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.triggerCharSet,t,n.requireLeadingSpace,r),!r&&(n.setTriggerText(""),angular.element(n.targetElement).triggerHandler("change"),n.isContentEditable())){n.contentEditableMenuPasted=!0;var o=i(function(){n.contentEditableMenuPasted=!1},200);n.$on("$destroy",function(){i.cancel(o)})}},n.hideAll=function(){for(var e in n.triggerCharMap)n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].hideMenu()},n.getActiveMenuScope=function(){for(var e in n.triggerCharMap)if(n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible)return n.triggerCharMap[e];return null},n.selectActive=function(){for(var e in n.triggerCharMap)n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible&&n.triggerCharMap[e].selectActive()},n.isActive=function(){for(var e in n.triggerCharMap)if(n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible)return!0;return!1},n.isContentEditable=function(){return"INPUT"!==n.targetElement.nodeName&&"TEXTAREA"!==n.targetElement.nodeName},n.replaceMacro=function(t,r){r?e.replaceMacroText(n.context(),n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.macros,n.macros[t]):(n.replacingMacro=!0,n.timer=i(function(){e.replaceMacroText(n.context(),n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.macros,n.macros[t]),angular.element(n.targetElement).triggerHandler("change"),n.replacingMacro=!1},300),n.$on("$destroy",function(){i.cancel(n.timer)}))},n.addMenu=function(e){e.parentScope&&n.triggerCharMap.hasOwnProperty(e.triggerChar)||(n.triggerCharMap[e.triggerChar]=e,void 0===n.triggerCharSet&&(n.triggerCharSet=[]),n.triggerCharSet.push(e.triggerChar),e.setParent(n))},n.$on("menuCreated",function(e,t){(void 0!==r.id||void 0!==r.mentioId)&&(r.id===t.targetElement||void 0!==r.mentioId&&n.altId===t.targetElement)&&n.addMenu(t.scope)}),t.on("click",function(){n.isActive()&&n.$apply(function(){n.hideAll()})}),t.on("keydown keypress paste",function(e){var t=n.getActiveMenuScope();t&&((9===e.which||13===e.which)&&(e.preventDefault(),t.selectActive()),27===e.which&&(e.preventDefault(),t.$apply(function(){t.hideMenu()})),40===e.which&&(e.preventDefault(),t.$apply(function(){t.activateNextItem()}),t.adjustScroll(1)),38===e.which&&(e.preventDefault(),t.$apply(function(){t.activatePreviousItem()}),t.adjustScroll(-1)),(37===e.which||39===e.which)&&e.preventDefault())})}],link:function(t,o,a){function c(e){function n(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}var i=t.getActiveMenuScope();if(i){if(9===e.which||13===e.which)return n(e),i.selectActive(),!1;if(27===e.which)return n(e),i.$apply(function(){i.hideMenu()}),!1;if(40===e.which)return n(e),i.$apply(function(){i.activateNextItem()}),i.adjustScroll(1),!1;if(38===e.which)return n(e),i.$apply(function(){i.activatePreviousItem()}),i.adjustScroll(-1),!1;if(37===e.which||39===e.which)return n(e),!1}}if(t.triggerCharMap={},t.targetElement=o,a.mentioItems){t.localItems=[],t.parentScope=t;var l=a.mentioSearch?' mentio-items="items"':' mentio-items="localItems"';t.defaultTriggerChar=a.mentioTriggerChar?t.$eval(a.mentioTriggerChar):"@";var s='<mentio-menu mentio-search="bridgeSearch(term)" mentio-select="bridgeSelect(item)"'+l;a.mentioTemplateUrl&&(s=s+' mentio-template-url="'+a.mentioTemplateUrl+'"'),t.menuPosition&&(s=s+" mentio-menu-position=\"'"+t.menuPosition+"'\""),t.container&&(s=s+" mentio-container=\"'"+t.container+"'\""),s=s+" mentio-trigger-char=\"'"+t.defaultTriggerChar+'\'" mentio-parent-scope="parentScope"/>';var u=n(s),m=u(t);o.parent().append(m),t.$on("$destroy",function(){m.remove()})}a.mentioTypedTerm&&(t.syncTriggerText=!0),t.$watch("iframeElement",function(e){if(e){var n=e.contentWindow.document;n.addEventListener("click",function(){t.isActive()&&t.$apply(function(){t.hideAll()})}),n.addEventListener("keydown",c,!0),t.$on("$destroy",function(){n.removeEventListener("keydown",c)})}}),t.$watch("ngModel",function(n){if(n&&""!==n||t.isActive()){if(void 0===t.triggerCharSet)return i.error("Error, no mentio-items attribute was provided, and no separate mentio-menus were specified.  Nothing to do."),void 0;if(t.contentEditableMenuPasted)return t.contentEditableMenuPasted=!1,void 0;t.replacingMacro&&(r.cancel(t.timer),t.replacingMacro=!1);var o=t.isActive(),a=t.isContentEditable(),c=e.getTriggerInfo(t.context(),t.triggerCharSet,t.requireLeadingSpace,o);if(void 0!==c&&(!o||o&&(a&&c.mentionTriggerChar===t.currentMentionTriggerChar||!a&&c.mentionPosition===t.currentMentionPosition)))c.mentionSelectedElement&&(t.targetElement=c.mentionSelectedElement,t.targetElementPath=c.mentionSelectedPath,t.targetElementSelectedOffset=c.mentionSelectedOffset),t.setTriggerText(c.mentionText),t.currentMentionPosition=c.mentionPosition,t.currentMentionTriggerChar=c.mentionTriggerChar,t.query(c.mentionTriggerChar,c.mentionText);else{var l=t.typedTerm;t.setTriggerText(""),t.hideAll();var s=e.getMacroMatch(t.context(),t.macros);if(void 0!==s)t.targetElement=s.macroSelectedElement,t.targetElementPath=s.macroSelectedPath,t.targetElementSelectedOffset=s.macroSelectedOffset,t.replaceMacro(s.macroText,s.macroHasTrailingSpace);else if(t.selectNotFound&&l&&""!==l){var u=t.triggerCharMap[t.currentMentionTriggerChar];if(u){var m=u.select({item:{label:l}});"function"==typeof m.then?m.then(t.replaceText):t.replaceText(m,!0)}}}}})}}}]).directive("mentioMenu",["mentioUtil","$rootScope","$log","$window","$document",function(e,t,n,i,r){return{restrict:"E",scope:{search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"=mentioTriggerChar",forElem:"=mentioFor",parentScope:"=mentioParentScope",menuPosition:"=mentioMenuPosition",container:"=mentioContainer"},templateUrl:function(e,t){return void 0!==t.mentioTemplateUrl?t.mentioTemplateUrl:"mentio-menu.tpl.html"},controller:["$scope",function(e){e.visible=!1,this.activate=e.activate=function(t){e.activeItem=t},this.isActive=e.isActive=function(t){return e.activeItem===t},this.selectItem=e.selectItem=function(t){var n=e.select({item:t});"function"==typeof n.then?n.then(e.parentMentio.replaceText):e.parentMentio.replaceText(n)},e.activateNextItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[(t+1)%e.items.length])},e.activatePreviousItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[0===t?e.items.length-1:t-1])},e.isFirstItemActive=function(){var t=e.items.indexOf(e.activeItem);return 0===t},e.isLastItemActive=function(){var t=e.items.indexOf(e.activeItem);return t===e.items.length-1},e.selectActive=function(){e.selectItem(e.activeItem)},e.isVisible=function(){return e.visible},e.displayAbove=function(){return"top"===e.menuPosition},e.showMenu=function(){e.visible||(e.requestVisiblePendingSearch=!0)},e.setParent=function(t){e.parentMentio=t,e.targetElement=t.targetElement}}],link:function(o,a){a[0].parentNode.removeChild(a[0]),r[0].body.appendChild(a[0]),o.menuElement=a;var c=$(o.container);if(c.length||(c=$(window)),o.parentScope)o.parentScope.addMenu(o);else{if(!o.forElem)return n.error("mentio-menu requires a target element in tbe mentio-for attribute"),void 0;if(!o.triggerChar)return n.error("mentio-menu requires a trigger char"),void 0;t.$broadcast("menuCreated",{targetElement:o.forElem,scope:o})}angular.element(i).bind("resize",function(){if(o.isVisible()){var t=[];t.push(o.triggerChar),e.popUnderMention(o.parentMentio.context(),t,a,c,o.requireLeadingSpace,o.displayAbove())}}),o.displayAbove()&&o.$watch(function(){return a[0].scrollHeight},function(t,n){Math.abs(t-n)>2&&e.updatePositionTop(a,c,t,n)}),o.$watch("items",function(e){e&&e.length>0?(o.activate(e[0]),!o.visible&&o.requestVisiblePendingSearch&&(o.visible=!0,o.requestVisiblePendingSearch=!1)):o.hideMenu()}),o.$watch("isVisible()",function(t){if(t){var n=[];n.push(o.triggerChar),e.popUnderMention(o.parentMentio.context(),n,a,c,o.requireLeadingSpace,o.displayAbove())}}),o.parentMentio.$on("$destroy",function(){a.remove()}),o.hideMenu=function(){o.visible=!1,a.css("display","none")},o.adjustScroll=function(e){var t=a[0],n=t.querySelector("ul"),i=t.querySelector("[mentio-menu-item].active");return o.isFirstItemActive()?n.scrollTop=0:o.isLastItemActive()?n.scrollTop=n.scrollHeight:(1===e?n.scrollTop+=i.offsetHeight:n.scrollTop-=i.offsetHeight,void 0)}}}}]).directive("mentioMenuItem",function(){return{restrict:"A",scope:{item:"=mentioMenuItem"},require:"^mentioMenu",link:function(e,t,n,i){e.$watch(function(){return i.isActive(e.item)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){i.activate(e.item)})}),t.bind("click",function(){return i.selectItem(e.item),!1})}}}).filter("unsafe",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("mentioHighlight",function(){function e(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(t,n,i){if(n){var r=i?'<span class="'+i+'">$&</span>':"<strong>$&</strong>";return(""+t).replace(new RegExp(e(n),"gi"),r)}return t}}),angular.module("mentio").factory("mentioUtil",["$window","$location","$anchorScroll","$timeout",function(e,t,n,i){function r(e,t,n,r,a,s){var u,m=v(e,t,a,!1);if(void 0!==m){u=l(e)?M(e,S(e).activeElement,m.mentionPosition):C(e,m.mentionPosition);var g=u.top,d=r[0].scrollTop||0;if(s){var f=o(S(e).activeElement,"font-size").replace("px","");g-=n[0].scrollHeight+f}n.css({top:g-d+"px",left:u.left+"px",position:"absolute",zIndex:100,display:"block"}),i(function(){c(e,n)},0)}else n.css({display:"none"})}function o(e,t){var n=function(e){return e.replace(/\-(\w)/g,function(e,t){return t.toUpperCase()})};return e.currentStyle?e.currentStyle[n(t)]:document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e,null).getPropertyValue(t):e.style[n(t)]}function a(e,t,n,i){var r=e[0].offsetTop;e.css({top:r-n+i+"px"})}function c(t,n){for(var i,r=20,o=100,a=n[0];void 0===i||0===i.height;)if(i=a.getBoundingClientRect(),0===i.height&&(a=a.childNodes[0],void 0===a||!a.getBoundingClientRect))return;var c=i.top,l=c+i.height;if(0>c)e.scrollTo(0,e.pageYOffset+i.top-r);else if(l>e.innerHeight){var s=e.pageYOffset+i.top-r;s-e.pageYOffset>o&&(s=e.pageYOffset+o);var u=e.pageYOffset-(e.innerHeight-l);u>s&&(u=s),e.scrollTo(0,u)}}function l(e){var t=S(e).activeElement;if(null!==t){var n=t.nodeName,i=t.getAttribute("type");return"INPUT"===n&&"text"===i||"TEXTAREA"===n}return!1}function s(e,t,n,i){var r,o=t;if(n)for(var a=0;a<n.length;a++){if(o=o.childNodes[n[a]],void 0===o)return;for(;o.length<i;)i-=o.length,o=o.nextSibling;0!==o.childNodes.length||o.length||(o=o.previousSibling)}var c=T(e);r=S(e).createRange(),r.setStart(o,i),r.setEnd(o,i),r.collapse(!0);try{c.removeAllRanges()}catch(l){}c.addRange(r),t.focus()}function u(e,t,n,i){var r,o;o=T(e),r=S(e).createRange(),r.setStart(o.anchorNode,n),r.setEnd(o.anchorNode,i),r.deleteContents();var a=S(e).createElement("div");a.innerHTML=t;for(var c,l,s=S(e).createDocumentFragment();c=a.firstChild;)l=s.appendChild(c);r.insertNode(s),l&&(r=r.cloneRange(),r.setStartAfter(l),r.collapse(!0),o.removeAllRanges(),o.addRange(r))}function m(e,t,n,i){var r=t.nodeName;"INPUT"===r||"TEXTAREA"===r?t!==S(e).activeElement&&t.focus():s(e,t,n,i)}function g(e,t,n,i,r,o){m(e,t,n,i);var a=p(e,r);if(a.macroHasTrailingSpace&&(a.macroText=a.macroText+" ",o+=" "),void 0!==a){var c=S(e).activeElement;if(l(e)){var s=a.macroPosition,g=a.macroPosition+a.macroText.length;c.value=c.value.substring(0,s)+o+c.value.substring(g,c.value.length),c.selectionStart=s+o.length,c.selectionEnd=s+o.length}else u(e,o,a.macroPosition,a.macroPosition+a.macroText.length)}}function d(e,t,n,i,r,o,a,c){m(e,t,n,i);var s=v(e,r,a,!0,c);if(void 0!==s)if(l()){var g=S(e).activeElement;o+=" ";var d=s.mentionPosition,f=s.mentionPosition+s.mentionText.length+1;g.value=g.value.substring(0,d)+o+g.value.substring(f,g.value.length),g.selectionStart=d+o.length,g.selectionEnd=d+o.length}else o+=" ",u(e,o,s.mentionPosition,s.mentionPosition+s.mentionText.length+1)}function f(e,t){if(null===t.parentNode)return 0;for(var n=0;n<t.parentNode.childNodes.length;n++){var i=t.parentNode.childNodes[n];if(i===t)return n}}function p(e,t){var n,i,r=[];if(l(e))n=S(e).activeElement;else{var o=h(e);o&&(n=o.selected,r=o.path,i=o.offset)}var a=b(e);if(void 0!==a&&null!==a){var c,s=!1;if(a.length>0&&(" "===a.charAt(a.length-1)||" "===a.charAt(a.length-1))&&(s=!0,a=a.substring(0,a.length-1)),angular.forEach(t,function(e,t){var o=a.toUpperCase().lastIndexOf(t.toUpperCase());if(o>=0&&t.length+o===a.length){var l=o-1;(0===o||" "===a.charAt(l)||" "===a.charAt(l))&&(c={macroPosition:o,macroText:t,macroSelectedElement:n,macroSelectedPath:r,macroSelectedOffset:i,macroHasTrailingSpace:s})}}),c)return c}}function h(e){var t,n=T(e),i=n.anchorNode,r=[];if(null!=i){for(var o,a=i.contentEditable;null!==i&&"true"!==a;)o=f(e,i),r.push(o),i=i.parentNode,null!==i&&(a=i.contentEditable);return r.reverse(),t=n.getRangeAt(0).startOffset,{selected:i,path:r,offset:t}}}function v(e,t,n,i,r){var o,a,c;if(l(e))o=S(e).activeElement;else{var s=h(e);s&&(o=s.selected,a=s.path,c=s.offset)}var u=b(e);if(void 0!==u&&null!==u){var m,g=-1;if(t.forEach(function(e){var t=u.lastIndexOf(e);t>g&&(g=t,m=e)}),g>=0&&(0===g||!n||/[\xA0\s]/g.test(u.substring(g-1,g)))){var d=u.substring(g+1,u.length);m=u.substring(g,g+1);var f=d.substring(0,1),p=d.length>0&&(" "===f||" "===f);if(r&&(d=d.trim()),!p&&(i||!/[\xA0\s]/g.test(d)))return{mentionPosition:g,mentionText:d,mentionSelectedElement:o,mentionSelectedPath:a,mentionSelectedOffset:c,mentionTriggerChar:m}}}}function T(e){return e?e.iframe.contentWindow.getSelection():window.getSelection()}function S(e){return e?e.iframe.contentWindow.document:document}function b(e){var t;if(l(e)){var n=S(e).activeElement,i=n.selectionStart;t=n.value.substring(0,i)}else{var r=T(e).anchorNode;if(null!=r){var o=r.textContent,a=T(e).getRangeAt(0).startOffset;a>=0&&(t=o.substring(0,a))}}return t}function C(e,t){var n,i,r="﻿",o="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),a=T(e),c=a.getRangeAt(0);i=S(e).createRange(),i.setStart(a.anchorNode,t),i.setEnd(a.anchorNode,t),i.collapse(!1),n=S(e).createElement("span"),n.id=o,n.appendChild(S(e).createTextNode(r)),i.insertNode(n),a.removeAllRanges(),a.addRange(c);var l={left:0,top:n.offsetHeight};return E(e,n,l),n.parentNode.removeChild(n),l}function E(e,t,n){for(var i=t,r=e?e.iframe:null;i;)n.left+=i.offsetLeft,n.top+=i.offsetTop,i!==S().body&&(n.top-=i.scrollTop,n.left-=i.scrollLeft),i=i.offsetParent,!i&&r&&(i=r,r=null)}function M(e,t,n){var i=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],r=null!==window.mozInnerScreenX,o=S(e).createElement("div");o.id="input-textarea-caret-position-mirror-div",S(e).body.appendChild(o);var a=o.style,c=window.getComputedStyle?getComputedStyle(t):t.currentStyle;a.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(a.wordWrap="break-word"),a.position="absolute",a.visibility="hidden",i.forEach(function(e){a[e]=c[e]}),r?(a.width=parseInt(c.width)-2+"px",t.scrollHeight>parseInt(c.height)&&(a.overflowY="scroll")):a.overflow="hidden",o.textContent=t.value.substring(0,n),"INPUT"===t.nodeName&&(o.textContent=o.textContent.replace(/\s/g," "));var l=S(e).createElement("span");l.textContent=t.value.substring(n)||".",o.appendChild(l);var s={top:l.offsetTop+parseInt(c.borderTopWidth)+parseInt(c.fontSize),left:l.offsetLeft+parseInt(c.borderLeftWidth)};return E(e,t,s),S(e).body.removeChild(o),s}return{popUnderMention:r,updatePositionTop:a,replaceMacroText:g,replaceTriggerText:d,getMacroMatch:p,getTriggerInfo:v,selectElement:s,getTextAreaOrInputUnderlinePosition:M,getTextPrecedingCurrentSelection:b,getContentEditableSelectedPath:h,getNodePositionInParent:f,getContentEditableCaretPosition:C,pasteHtml:u,resetSelection:m,scrollIntoView:c}}]),angular.module("mentio").run(["$templateCache",function(e){e.put("mentio-menu.tpl.html",'<style>\n.scrollable-menu {\n    height: auto;\n    max-height: 300px;\n    overflow: auto;\n}\n\n.menu-highlighted {\n    font-weight: bold;\n}\n</style>\n<ul class="dropdown-menu scrollable-menu" style="display:block">\n    <li mentio-menu-item="item" ng-repeat="item in items track by $index">\n        <a class="text-primary" ng-bind-html="item.label | mentioHighlight:typedTerm:\'menu-highlighted\' | unsafe"></a>\n    </li>\n</ul>')}]);